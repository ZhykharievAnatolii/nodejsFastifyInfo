# Basic Node.js

## Шаги, чтобы пользоваться nodejs

### Установить если нет(всегда берем четные версии). Скачать [тут](https://nodejs.org/en/)

### У нас есть две команды после. Это ```npm``` и ```node```

Вы можете запустить любой js mjs файл командой 
```bash
    node ./path/to/file.js
    # or
    node ./path/to/file.mjs
```

Команда ```npm``` это пакетный менеджер, который управляет зависимостями(библиотек)

Чтобы ими управлять у нас создается файл ```package.json```

Если его нет и вы создаете только проект, его создать можно командой 
```bash
    npm init -y
```
И после этого у вас создается этот файл.

После вы уже можете устанавливать зависимости командой 

```bash
    npm install fastify
    # or
    npm i fastify
```

И у нас создается свойство в файле ```package.json``` ```dependencies```(только если его изначально не было, если был, просто добавляется графа с этой библиотекой и версией)
Также есть отдельные виды библиотек, которые обычно не нужны непосредственно в коде, а являются инструментами. Для таких вещей принято устанавливать в отдельное свойство, ```devDependencies```(то есть зависимости разработки, которые не участвуют напрямую в коде)

```bash
npm i -D nodemon
```

Когда вы например клоните проект у которого уже есть файл зависимостями и вам нужно их все установить, делайте команду

```bash
npm i 
# or
npm install
```

## Импорты

На уровне Node.js, чтобы пользоваться импортами как в браузере нужно дать расширение .mjs.
Чтобы заимпортить локальный файл, используем такой синтаксис:

```
# file structure
index.mjs - we opened this file
operations.mjs
```

```js
import defaultVariable from './operations.mjs';
```

Если файл находится где-то выше, то тогда так

```js
import defaultVariable from '../operations.mjs';
```

Но если мы установили библиотеку и посмотрели в доке как нужно импортить, то тогда используем импорт без точек в начале. Любой импорт с путем без точек в начале будет искаться в папке ```node_modules```

```js
import fastify from 'fastify';
```

> P.S. Только не забудьте установить, иначе будет ошибка

Помните, когда вы запускаете ваш файл, если там нет никаких отложенных задач(запущенного сервера, интервала или таймаута или запроса), то тогда после команды запуска после выполнения стека вызовов, терминал отдается вам, ибо нет работы и программа останавливается

Если в очередях или отложках есть задачи, то пока они не выполнятся все, программа будет работать, или упадет если будет ошибка.

## Fastify

Фастифай это низкоуровневый фреймворк для создания http-серверов. Чтобы его использовать, делаем пошагово

- устанавливаем его в основные зависимости
```bash
npm i fastify
```
- после этого создавайте любой файл, в котором будете работать и импортим его из зависимостей
```js
import fastify from 'fastify';
```
- после этого, чтобы создать объект сервера, нужно вызвать эту функцию фастивай. Она вернет этот объект, поэтому мы запишем его в переменную
```js
const server = fastify({
    logger: true,
});
```
> Для подробностей о дополнительных конфигурациях, что можно ещё за свойства передавать для точной настройки сервера при создании можете посмотреть в [документации](https://www.fastify.io/docs/latest/Reference/Server/)
- Итак, сервер создан, но если запустить этот файл, программа мгновенно закончится. Для работы сервера нужно занять порт и хост, это будет делаться методом ```.listen()```. Передаем туда объект конфигурации, отдельно свойство для порта и хоста
```js
server
    .listen({
        port: 3000,
        host: '0.0.0.0',
    })
    .then(() => console.log('server was started'))
    .catch((err) => console.log(`We have problems ${err.message}`))
```
> И да, ```.listen()``` возвращает промис, можем добавить then если успешно сервер запуститься или обработать ошибку сatch(например порт уже занят или ещё какая ошибка). Все опции метода listen можно посмотреть в [документации](https://www.fastify.io/docs/latest/Reference/Server/#listen)
- Уже при запуске программа не будет останавливаться и будет слушать все запросы на локальном хосте на выбранном порту. Но пока что у нас не указано никаких запросов, поэтому на любой запрос по нашему хосту и порту фастифай будет автоматически отвечать 404
- Между слушанием порта и созданием можем создавать обработчики запросов.

## Обработчики запросов

Давайте вспомним как мы можем давать события DOM-элементам

```js
const button = document.querySelector('button');

button?.addEventListener('click', (event) => {
    console.log(event);
});
```
И в единственном аргументе event любого события содержится вся информация, например, какой кнопкой был сделан клик, или какая позиция в этот момент у курсора была

Тут очень похожая вещь, мы берем инстанс нашего сервера(в данном примере это переменная ```server```) и говорим с помощью js-метода какой метод мы будем слушать(post, get, put, patch, delete)

И в каждом методе по 2-3 аргумента(пока говорим про 2). Первый это мы выбираем роут, строкой, обязательно начинается со слэша. А второй, это функция-обработчик, которая вызовется, когда ваш запрос придет именно на этот роут(подобным образом, если бы мы кликнули на кнопку, вызвалась бы функция в обработчике события)

В функции которую вы дадите в фастифай есть два аргумента, первый отвечает за запрос, второй за ответ сервера.

```js
server.post('/users', (request, reply) => {
    console.log(request.headers); // выведет заголовки, которые пришли с запроса клиента
    
    reply.send({ info: 'Success' }); // Ответит неявно 200 статусом, отправит этот объект, но перед этим автоматически сделает ему JSON.parse()
});
```
Важный нюанс, если вы не делаете ответ, то клиент будет висеть и ждать ответ, и будет ждать это крайне долго

> Подробно почитайте в документации про свойства-методы [запроса](https://www.fastify.io/docs/latest/Reference/Request/) или [ответа](https://www.fastify.io/docs/latest/Reference/Reply/)
